# name: Deploy to Production

# on:
#   workflow_dispatch:  # Manual deployment
#     inputs:
#       environment:
#         description: 'Environment to deploy to'
#         required: true
#         default: 'production'
#         type: choice
#         options:
#           - production
#           - staging
#       version:
#         description: 'Docker image tag to deploy'
#         required: false
#         default: 'latest'

# env:
#   DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

# jobs:
#   pre-deployment-check:
#     name: Pre-Deployment Checks
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Verify Docker images exist
#         run: |
#           echo "Checking if Docker images exist..."
#           services=("api_gateway" "user_service" "template_service" "email_service" "push_service")
          
#           for service in "${services[@]}"; do
#             echo "Checking: ${{ env.DOCKER_USERNAME }}/notification-${service}:${{ github.event.inputs.version }}"
#             # Add actual check logic here
#           done
      
#       - name: Run smoke tests on staging
#         if: github.event.inputs.environment == 'production'
#         run: |
#           echo "Running smoke tests on staging environment..."
#           # Add smoke test commands

#   backup-database:
#     name: Backup Database
#     runs-on: ubuntu-latest
#     needs: pre-deployment-check
#     if: github.event.inputs.environment == 'production'
    
#     steps:
#       - name: Create database backup
#         uses: appleboy/ssh-action@master
#         with:
#           host: ${{ secrets.PRODUCTION_HOST }}
#           username: ${{ secrets.PRODUCTION_USER }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           script: |
#             echo "Creating database backup..."
#             TIMESTAMP=$(date +%Y%m%d_%H%M%S)
#             docker exec postgres pg_dump -U postgres notification_db > /backup/db_${TIMESTAMP}.sql
#             echo "‚úÖ Backup created: /backup/db_${TIMESTAMP}.sql"

#   deploy:
#     name: Deploy to ${{ github.event.inputs.environment }}
#     runs-on: ubuntu-latest
#     needs: [pre-deployment-check, backup-database]
#     if: always() && (needs.backup-database.result == 'success' || needs.backup-database.result == 'skipped')
    
#     environment:
#       name: ${{ github.event.inputs.environment }}
#       url: https://${{ secrets.PRODUCTION_HOST }}
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Setup SSH
#         uses: webfactory/ssh-agent@v0.8.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
#       - name: Deploy via SSH
#         uses: appleboy/ssh-action@master
#         with:
#           host: ${{ secrets.PRODUCTION_HOST }}
#           username: ${{ secrets.PRODUCTION_USER }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           script: |
#             set -e
            
#             echo "üöÄ Starting deployment..."
#             cd /opt/distributed-notification-system
            
#             # Pull latest code
#             git pull origin main
            
#             # Export environment variables
#             export IMAGE_TAG=${{ github.event.inputs.version }}
            
#             # Pull Docker images
#             docker-compose -f docker-compose.prod.yml pull
            
#             # Start new containers (zero-downtime)
#             docker-compose -f docker-compose.prod.yml up -d --remove-orphans
            
#             # Wait for services
#             sleep 15
            
#             # Health check
#             if curl -f http://localhost/health; then
#               echo "‚úÖ Health check passed"
#             else
#               echo "‚ùå Health check failed - Rolling back"
#               docker-compose -f docker-compose.prod.yml down
#               exit 1
#             fi
            
#             # Cleanup
#             docker system prune -af
            
#             echo "‚úÖ Deployment successful!"
      
#       - name: Verify deployment
#         run: |
#           sleep 10
#           curl -f https://${{ secrets.PRODUCTION_HOST }}/health || exit 1

#   post-deployment:
#     name: Post-Deployment Tasks
#     runs-on: ubuntu-latest
#     needs: deploy
#     if: success()
    
#     steps:
#       - name: Run database migrations
#         uses: appleboy/ssh-action@master
#         with:
#           host: ${{ secrets.PRODUCTION_HOST }}
#           username: ${{ secrets.PRODUCTION_USER }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           script: |
#             cd /opt/distributed-notification-system
#             docker-compose -f docker-compose.prod.yml exec -T user_service alembic upgrade head || true
#             docker-compose -f docker-compose.prod.yml exec -T template_service alembic upgrade head || true
      
#       - name: Clear caches
#         uses: appleboy/ssh-action@master
#         with:
#           host: ${{ secrets.PRODUCTION_HOST }}
#           username: ${{ secrets.PRODUCTION_USER }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           script: |
#             docker exec redis redis-cli FLUSHDB
      
#       - name: Send deployment notification
#         run: |
#           echo "‚úÖ Deployment to ${{ github.event.inputs.environment }} completed successfully!"
#           echo "Version: ${{ github.event.inputs.version }}"
#           echo "Deployed by: ${{ github.actor }}"
#           echo "Timestamp: $(date)"

#   rollback:
#     name: Rollback Deployment
#     runs-on: ubuntu-latest
#     needs: deploy
#     if: failure()
    
#     steps:
#       - name: Rollback to previous version
#         uses: appleboy/ssh-action@master
#         with:
#           host: ${{ secrets.PRODUCTION_HOST }}
#           username: ${{ secrets.PRODUCTION_USER }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           script: |
#             echo "üîÑ Rolling back deployment..."
#             cd /opt/distributed-notification-system
            
#             # Restore from backup
#             LATEST_BACKUP=$(ls -t /backup/db_*.sql | head -1)
#             if [ -f "$LATEST_BACKUP" ]; then
#               docker exec -i postgres psql -U postgres notification_db < $LATEST_BACKUP
#               echo "‚úÖ Database restored from backup"
#             fi
            
#             # Restart previous containers
#             docker-compose -f docker-compose.prod.yml down
#             git checkout HEAD~1
#             docker-compose -f docker-compose.prod.yml up -d
            
#             echo "‚úÖ Rollback completed"