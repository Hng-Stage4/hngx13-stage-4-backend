# name: Run Tests

# on:
#   push:
#     branches: [ main, develop, feature/** ]
#   pull_request:
#     branches: [ main, develop ]
#   workflow_dispatch:  # Manual trigger

# env:
#   PYTHON_VERSION: '3.11'

# jobs:
#   lint:
#     name: Lint Code
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}
      
#       - name: Install linting tools
#         run: |
#           pip install flake8 black isort mypy
      
#       - name: Run Black (formatter check)
#         run: black --check services/
      
#       - name: Run isort (import sorting)
#         run: isort --check-only services/
      
#       - name: Run Flake8 (linter)
#         run: flake8 services/ --max-line-length=100 --exclude=__pycache__,migrations
      
#       - name: Run MyPy (type checker)
#         run: mypy services/api_gateway/app --ignore-missing-imports

#   unit-tests:
#     name: Unit Tests - ${{ matrix.service }}
#     runs-on: ubuntu-latest
    
#     strategy:
#       fail-fast: false
#       matrix:
#         service: [api_gateway, user_service, template_service, email_service, push_service]
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}
      
#       - name: Cache dependencies
#         uses: actions/cache@v3
#         with:
#           path: ~/.cache/pip
#           key: ${{ runner.os }}-pip-${{ hashFiles('services/${{ matrix.service }}/requirements.txt') }}
      
#       - name: Install dependencies
#         run: |
#           pip install --upgrade pip
#           pip install pytest pytest-cov pytest-asyncio pytest-mock httpx
#           if [ -f services/${{ matrix.service }}/requirements.txt ]; then
#             pip install -r services/${{ matrix.service }}/requirements.txt
#           fi
      
#       - name: Run unit tests
#         run: |
#           if [ -d "services/${{ matrix.service }}/tests" ]; then
#             pytest services/${{ matrix.service }}/tests/ \
#               -v \
#               --cov=services/${{ matrix.service }}/app \
#               --cov-report=xml \
#               --cov-report=html \
#               --cov-report=term-missing \
#               --cov-fail-under=70
#           else
#             echo "⚠️  No tests found for ${{ matrix.service }}"
#             exit 0
#           fi
      
#       - name: Upload coverage reports
#         uses: codecov/codecov-action@v3
#         with:
#           file: ./coverage.xml
#           flags: ${{ matrix.service }}
#           name: ${{ matrix.service }}-coverage
      
#       - name: Upload HTML coverage report
#         uses: actions/upload-artifact@v3
#         with:
#           name: coverage-${{ matrix.service }}
#           path: htmlcov/

#   integration-tests:
#     name: Integration Tests
#     runs-on: ubuntu-latest
#     needs: [lint, unit-tests]
    
#     services:
#       rabbitmq:
#         image: rabbitmq:3-management
#         ports:
#           - 5672:5672
#           - 15672:15672
#         options: >-
#           --health-cmd "rabbitmq-diagnostics ping"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
      
#       redis:
#         image: redis:7-alpine
#         ports:
#           - 6379:6379
#         options: >-
#           --health-cmd "redis-cli ping"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
      
#       postgres:
#         image: postgres:15-alpine
#         env:
#           POSTGRES_USER: test_user
#           POSTGRES_PASSWORD: test_password
#           POSTGRES_DB: test_db
#         ports:
#           - 5432:5432
#         options: >-
#           --health-cmd pg_isready
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}
      
#       - name: Install dependencies
#         run: |
#           pip install --upgrade pip
#           pip install pytest pytest-asyncio httpx
#           pip install -r services/api_gateway/requirements.txt
      
#       - name: Run integration tests
#         env:
#           RABBITMQ_URL: amqp://guest:guest@localhost:5672/
#           REDIS_HOST: localhost
#           REDIS_PORT: 6379
#           POSTGRES_HOST: localhost
#           POSTGRES_PORT: 5432
#           POSTGRES_USER: test_user
#           POSTGRES_PASSWORD: test_password
#           POSTGRES_DB: test_db
#         run: |
#           pytest services/api_gateway/tests/integration/ -v || echo "No integration tests yet"

#   security-scan:
#     name: Security Scanning
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Run Trivy vulnerability scanner
#         uses: aquasecurity/trivy-action@master
#         with:
#           scan-type: 'fs'
#           scan-ref: '.'
#           format: 'sarif'
#           output: 'trivy-results.sarif'
      
#       - name: Upload Trivy results to GitHub Security
#         uses: github/codeql-action/upload-sarif@v2
#         with:
#           sarif_file: 'trivy-results.sarif'
      
#       - name: Check Python dependencies for vulnerabilities
#         run: |
#           pip install safety
#           safety check --json || true

#   test-summary:
#     name: Test Summary
#     runs-on: ubuntu-latest
#     needs: [lint, unit-tests, integration-tests, security-scan]
#     if: always()
    
#     steps:
#       - name: Check test results
#         run: |
#           if [ "${{ needs.lint.result }}" != "success" ]; then
#             echo "❌ Linting failed"
#             exit 1
#           fi
#           if [ "${{ needs.unit-tests.result }}" != "success" ]; then
#             echo "❌ Unit tests failed"
#             exit 1
#           fi
#           if [ "${{ needs.integration-tests.result }}" != "success" ]; then
#             echo "⚠️  Integration tests failed (non-blocking)"
#           fi
#           echo "✅ All critical tests passed!"