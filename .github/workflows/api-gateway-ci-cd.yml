# # ============================================
# # .github/workflows/api-gateway-ci-cd.yml
# # ============================================
# name: API Gateway CI/CD

# on:
#   push:
#     branches:
#       - main
#       - develop
#     paths:
#       - 'api-gateway/**'
#       - '.github/workflows/api-gateway-ci-cd.yml'
#   pull_request:
#     branches:
#       - main
#       - develop
#     paths:
#       - 'api-gateway/**'

# env:
#   REGISTRY: ghcr.io
#   IMAGE_NAME: ${{ github.repository }}/api-gateway

# jobs:
#   lint-and-test:
#     name: Lint and Test
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.11'
      
#       - name: Cache dependencies
#         uses: actions/cache@v3
#         with:
#           path: ~/.cache/pip
#           key: ${{ runner.os }}-pip-${{ hashFiles('api-gateway/requirements.txt') }}
#           restore-keys: |
#             ${{ runner.os }}-pip-
      
#       - name: Install dependencies
#         working-directory: ./api-gateway
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt
#           pip install pytest pytest-asyncio pytest-cov flake8 black
      
#       - name: Run Black formatter check
#         working-directory: ./api-gateway
#         run: black --check app/
      
#       - name: Run Flake8 linter
#         working-directory: ./api-gateway
#         run: flake8 app/ --max-line-length=100 --ignore=E501,W503
      
#       - name: Run tests
#         working-directory: ./api-gateway
#         run: |
#           pytest tests/ -v --cov=app --cov-report=xml --cov-report=term
      
#       - name: Upload coverage reports
#         uses: codecov/codecov-action@v3
#         with:
#           file: ./api-gateway/coverage.xml
#           flags: api-gateway
#           name: api-gateway-coverage

#   build-and-push:
#     name: Build and Push Docker Image
#     runs-on: ubuntu-latest
#     needs: lint-and-test
#     if: github.event_name == 'push'
    
#     permissions:
#       contents: read
#       packages: write
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3
      
#       - name: Log in to Container Registry
#         uses: docker/login-action@v3
#         with:
#           registry: ${{ env.REGISTRY }}
#           username: ${{ github.actor }}
#           password: ${{ secrets.GITHUB_TOKEN }}
      
#       - name: Extract metadata
#         id: meta
#         uses: docker/metadata-action@v5
#         with:
#           images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
#           tags: |
#             type=ref,event=branch
#             type=sha,prefix={{branch}}-
#             type=semver,pattern={{version}}
#             type=semver,pattern={{major}}.{{minor}}
      
#       - name: Build and push Docker image
#         uses: docker/build-push-action@v5
#         with:
#           context: ./api-gateway
#           file: ./api-gateway/Dockerfile
#           push: true
#           tags: ${{ steps.meta.outputs.tags }}
#           labels: ${{ steps.meta.outputs.labels }}
#           cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
#           cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

#   deploy:
#     name: Deploy to Server
#     runs-on: ubuntu-latest
#     needs: build-and-push
#     if: github.ref == 'refs/heads/main'
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Setup SSH
#         uses: webfactory/ssh-agent@v0.8.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
#       - name: Add server to known hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
#       - name: Deploy to server
#         env:
#           SERVER_HOST: ${{ secrets.SERVER_HOST }}
#           SERVER_USER: ${{ secrets.SERVER_USER }}
#           DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
#         run: |
#           ssh $SERVER_USER@$SERVER_HOST << 'EOF'
#             cd $DEPLOY_PATH
            
#             # Pull latest images
#             docker-compose pull api-gateway
            
#             # Restart service with zero downtime
#             docker-compose up -d --no-deps --build api-gateway
            
#             # Clean up old images
#             docker image prune -f
#           EOF
      
#       - name: Health check
#         run: |
#           sleep 10
#           curl -f http://${{ secrets.SERVER_HOST }}:3000/api/v1/health || exit 1
      
#       - name: Notify deployment status
#         if: always()
#         uses: 8398a7/action-slack@v3
#         with:
#           status: ${{ job.status }}
#           text: 'API Gateway deployment ${{ job.status }}'
#           webhook_url: ${{ secrets.SLACK_WEBHOOK }}

#   integration-tests:
#     name: Integration Tests
#     runs-on: ubuntu-latest
#     needs: build-and-push
    
#     services:
#       rabbitmq:
#         image: rabbitmq:3.12-management-alpine
#         ports:
#           - 5672:5672
#         options: >-
#           --health-cmd "rabbitmq-diagnostics ping"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
      
#       redis:
#         image: redis:7-alpine
#         ports:
#           - 6379:6379
#         options: >-
#           --health-cmd "redis-cli ping"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.11'
      
#       - name: Install dependencies
#         working-directory: ./api-gateway
#         run: |
#           pip install -r requirements.txt
#           pip install pytest pytest-asyncio httpx
      
#       - name: Run integration tests
#         working-directory: ./api-gateway
#         env:
#           RABBITMQ_HOST: localhost
#           REDIS_HOST: localhost
#         run: |
#           pytest tests/integration/ -v
