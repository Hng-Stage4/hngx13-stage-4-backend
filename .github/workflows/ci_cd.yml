# ============================================
# .github/workflows/deploy.yml
# Simple Deploy to Azure VM (Multi-Stack Support)
# Triggers only on merge to main
# ============================================
name: Deploy to Azure VM

on:
  push:
    branches:
      - main  # Only deploy when merged to main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      # ==========================================
      # 1. CHECKOUT CODE
      # ==========================================
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================
      # 2. SETUP SSH WITH PASSWORD
      # ==========================================
      - name: ðŸ” Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: ðŸ”‘ Add Azure VM to known hosts
        env:
          AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H $AZURE_VM_HOST >> ~/.ssh/known_hosts

      # ==========================================
      # 3. DEPLOY TO AZURE VM (WITH PASSWORD)
      # ==========================================
      - name: ðŸš€ Deploy to Azure VM
        env:
          AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          AZURE_VM_USER: ${{ secrets.AZURE_VM_USER }}
          AZURE_VM_PASSWORD: ${{ secrets.AZURE_VM_PASSWORD }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          sshpass -p "$AZURE_VM_PASSWORD" ssh -o StrictHostKeyChecking=no $AZURE_VM_USER@$AZURE_VM_HOST << 'ENDSSH'
            set -e  # Exit on any error
            
            echo "================================================"
            echo "ðŸš€ Starting Deployment"
            echo "================================================"
            
            # Navigate to deployment directory
            cd ${{ env.DEPLOY_PATH }}
            
            echo "ðŸ“¥ Pulling latest code from main..."
            git fetch origin
            git reset --hard origin/main
            
            echo "ðŸ³ Stopping existing containers..."
            docker-compose down
            
            echo "ðŸ”¨ Building and starting services..."
            docker-compose up --build -d
            
            echo "â³ Waiting for services to be ready..."
            sleep 15
            
            echo "âœ… Checking service status..."
            docker-compose ps
            
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -f
            
            echo "================================================"
            echo "âœ… Deployment Complete!"
            echo "================================================"
          ENDSSH

      # ==========================================
      # 4. HEALTH CHECKS
      # ==========================================
      - name: ðŸ¥ Health Check - API Gateway
        env:
          AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST }}
        run: |
          echo "Waiting for services to stabilize..."
          sleep 10
          
          echo "Checking API Gateway health..."
          curl -f http://$AZURE_VM_HOST:3000/api/v1/health || echo "âš ï¸ API Gateway health check failed"

      - name: ðŸ¥ Health Check - Services
        env:
          AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          AZURE_VM_USER: ${{ secrets.AZURE_VM_USER }}
          AZURE_VM_PASSWORD: ${{ secrets.AZURE_VM_PASSWORD }}
        run: |
          sshpass -p "$AZURE_VM_PASSWORD" ssh -o StrictHostKeyChecking=no $AZURE_VM_USER@$AZURE_VM_HOST << 'ENDSSH'
            echo "Checking all service statuses..."
            docker-compose ps
            
            # Check if any services are unhealthy
            if docker-compose ps | grep -q "Exit"; then
              echo "âŒ Some services failed to start!"
              docker-compose logs --tail=50
              exit 1
            else
              echo "âœ… All services are running!"
            fi
          ENDSSH

      # ==========================================
      # 5. DEPLOYMENT SUMMARY
      # ==========================================
      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "================================================"
          echo "ðŸ“Š Deployment Summary"
          echo "================================================"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Status: ${{ job.status }}"
          echo "================================================"
