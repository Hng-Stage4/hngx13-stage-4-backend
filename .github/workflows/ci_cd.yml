# # ============================================
# # .github/workflows/ci-cd.yml
# # Simple CI/CD Pipeline (Multi-Language)
# # ============================================
# name: CI/CD Pipeline

# on:
#   push:
#     branches: ['**']  # Run tests on every push to any branch
#   pull_request:
#     branches: [main]   # Run tests on PRs to main

# jobs:
#   # ==========================================
#   # TEST - Runs on every push
#   # ==========================================
#   test:
#     name: Test All Services
#     runs-on: ubuntu-latest
    
#     services:
#       postgres:
#         image: postgres:15-alpine
#         env:
#           POSTGRES_USER: admin
#           POSTGRES_PASSWORD: secret
#           POSTGRES_DB: notifications
#         ports:
#           - 5432:5432
#         options: >-
#           --health-cmd "pg_isready -U admin"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
      
#       redis:
#         image: redis:7-alpine
#         ports:
#           - 6379:6379
#         options: >-
#           --health-cmd "redis-cli ping"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
      
#       rabbitmq:
#         image: rabbitmq:3.12-management-alpine
#         env:
#           RABBITMQ_DEFAULT_USER: guest
#           RABBITMQ_DEFAULT_PASS: guest
#         ports:
#           - 5672:5672
#         options: >-
#           --health-cmd "rabbitmq-diagnostics ping"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       # ==========================================
#       # Python Services
#       # ==========================================
#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.11'
      
#       - name: Test Python services
#         env:
#           DATABASE_URL: postgresql://admin:secret@localhost:5432/notifications
#           REDIS_HOST: localhost
#           RABBITMQ_HOST: localhost
#         run: |
#           for service in services/*/; do
#             if [ -f "$service/requirements.txt" ]; then
#               echo "üêç Testing Python service: $service"
#               pip install -r "$service/requirements.txt"
#               pip install pytest pytest-asyncio
#               pytest "$service/tests/" -v || echo "‚ö†Ô∏è Tests failed or no tests found"
#             fi
#           done
      
#       # ==========================================
#       # Node.js/NestJS Services
#       # ==========================================
#       - name: Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '18'
      
#       - name: Test Node.js services
#         env:
#           DATABASE_URL: postgresql://admin:secret@localhost:5432/notifications
#           REDIS_HOST: localhost
#           RABBITMQ_HOST: localhost
#         run: |
#           for service in services/*/; do
#             if [ -f "$service/package.json" ]; then
#               echo "üì¶ Testing Node.js service: $service"
#               cd "$service"
#               npm install
#               npm test || echo "‚ö†Ô∏è Tests failed or no tests found"
#               cd -
#             fi
#           done
      
#       # ==========================================
#       # PHP Services
#       # ==========================================
#       - name: Set up PHP
#         uses: shivammathur/setup-php@v2
#         with:
#           php-version: '8.2'
#           extensions: mbstring, xml, pdo, pdo_pgsql, redis
#           tools: composer, phpunit
      
#       - name: Test PHP services
#         env:
#           DATABASE_URL: postgresql://admin:secret@localhost:5432/notifications
#           REDIS_HOST: localhost
#           RABBITMQ_HOST: localhost
#         run: |
#           for service in services/*/; do
#             if [ -f "$service/composer.json" ]; then
#               echo "üêò Testing PHP service: $service"
#               cd "$service"
#               composer install --no-interaction --prefer-dist
#               ./vendor/bin/phpunit || echo "‚ö†Ô∏è Tests failed or no tests found"
#               cd -
#             fi
#           done
  
#   # ==========================================
#   # DEPLOY - Only runs on merge to main
#   # ==========================================
#   deploy:
#     name: Deploy to Production
#     runs-on: ubuntu-latest
#     needs: test
#     if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Setup SSH
#         uses: webfactory/ssh-agent@v0.8.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
#       - name: Deploy to server
#         env:
#           SERVER_HOST: ${{ secrets.SERVER_HOST }}
#           SERVER_USER: ${{ secrets.SERVER_USER }}
#         run: |
#           ssh $SERVER_USER@$SERVER_HOST << 'EOF'
#             cd /opt/notification-system
            
#             echo "üì• Pulling latest changes..."
#             git pull origin main
            
#             echo "üê≥ Rebuilding and restarting services..."
#             docker-compose down
#             docker-compose build --no-cache
#             docker-compose up -d
            
#             echo "‚è≥ Waiting for services to be healthy..."
#             sleep 10
            
#             echo "‚úÖ Deployment complete!"
#             docker-compose ps
#           EOF
      
#       - name: Verify deployment
#         env:
#           SERVER_HOST: ${{ secrets.SERVER_HOST }}
#           SERVER_USER: ${{ secrets.SERVER_USER }}
#         run: |
#           ssh $SERVER_USER@$SERVER_HOST << 'EOF'
#             # Check if services are running
#             if docker-compose ps | grep -q "Up"; then
#               echo "‚úÖ Services are running"
#               exit 0
#             else
#               echo "‚ùå Some services failed to start"
#               docker-compose logs --tail=50
#               exit 1
#             fi
#           EOF