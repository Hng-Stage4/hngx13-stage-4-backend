# name: CI/CD Pipeline

# on:
#   push:
#     branches: [ main, develop ]
#   pull_request:
#     branches: [ main ]

# env:
#   DOCKER_REGISTRY: docker.io
#   DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

# jobs:
#   # Job 1: Run Tests
#   test:
#     name: Run Tests
#     runs-on: ubuntu-latest
    
#     strategy:
#       matrix:
#         service: [api_gateway, user_service, template_service, email_service, push_service]
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Set up Python 3.11
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.11'
      
#       - name: Cache Python dependencies
#         uses: actions/cache@v3
#         with:
#           path: ~/.cache/pip
#           key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
#           restore-keys: |
#             ${{ runner.os }}-pip-
      
#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install pytest pytest-cov pytest-asyncio
#           if [ -f services/${{ matrix.service }}/requirements.txt ]; then
#             pip install -r services/${{ matrix.service }}/requirements.txt
#           fi
      
#       - name: Run tests
#         run: |
#           if [ -d "services/${{ matrix.service }}/tests" ]; then
#             pytest services/${{ matrix.service }}/tests/ \
#               --cov=services/${{ matrix.service }}/app \
#               --cov-report=xml \
#               --cov-report=term-missing
#           else
#             echo "No tests found for ${{ matrix.service }}"
#           fi
      
#       - name: Upload coverage to Codecov
#         uses: codecov/codecov-action@v3
#         with:
#           file: ./coverage.xml
#           flags: ${{ matrix.service }}
#           name: ${{ matrix.service }}-coverage

#   # Job 2: Build and Push Docker Images
#   build-and-push:
#     name: Build and Push Docker Images
#     needs: test
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/main'
    
#     strategy:
#       matrix:
#         service: [api_gateway, user_service, template_service, email_service, push_service]
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3
      
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}
      
#       - name: Extract metadata
#         id: meta
#         uses: docker/metadata-action@v5
#         with:
#           images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_USERNAME }}/notification-${{ matrix.service }}
#           tags: |
#             type=ref,event=branch
#             type=sha,prefix={{branch}}-
#             type=raw,value=latest,enable={{is_default_branch}}
      
#       - name: Build and push ${{ matrix.service }}
#         uses: docker/build-push-action@v5
#         with:
#           context: ./services/${{ matrix.service }}
#           push: true
#           tags: ${{ steps.meta.outputs.tags }}
#           labels: ${{ steps.meta.outputs.labels }}
#           cache-from: type=gha
#           cache-to: type=gha,mode=max
#           build-args: |
#             BUILD_DATE=${{ github.event.head_commit.timestamp }}
#             VCS_REF=${{ github.sha }}
#             VERSION=${{ steps.meta.outputs.version }}

#   # Job 3: Deploy to Production
#   deploy:
#     name: Deploy to Production
#     needs: build-and-push
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/main'
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       - name: Setup SSH
#         uses: webfactory/ssh-agent@v0.8.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
#       - name: Add server to known hosts
#         run: |
#           mkdir -p ~/.ssh
#           ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts
      
#       - name: Deploy via SSH
#         env:
#           PRODUCTION_HOST: ${{ secrets.PRODUCTION_HOST }}
#           PRODUCTION_USER: ${{ secrets.PRODUCTION_USER }}
#         run: |
#           ssh $PRODUCTION_USER@$PRODUCTION_HOST << 'ENDSSH'
#             cd /opt/distributed-notification-system
            
#             # Pull latest code
#             git pull origin main
            
#             # Pull latest Docker images
#             docker-compose -f docker-compose.prod.yml pull
            
#             # Restart services (zero-downtime with watchtower)
#             docker-compose -f docker-compose.prod.yml up -d --remove-orphans
            
#             # Clean up old images
#             docker image prune -af
            
#             # Check health
#             sleep 10
#             curl -f http://localhost/health || exit 1
            
#             echo "✅ Deployment successful!"
#           ENDSSH
      
#       - name: Notify deployment status
#         if: always()
#         run: |
#           if [ "${{ job.status }}" == "success" ]; then
#             echo "✅ Deployment to production successful!"
#           else
#             echo "❌ Deployment to production failed!"
#           fi

#   # Job 4: Post-deployment health check
#   health-check:
#     name: Post-Deployment Health Check
#     needs: deploy
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/main'
    
#     steps:
#       - name: Wait for services to be ready
#         run: sleep 30
      
#       - name: Check API Gateway health
#         run: |
#           curl -f https://${{ secrets.PRODUCTION_HOST }}/health || exit 1
      
#       - name: Check Traefik dashboard
#         run: |
#           curl -f http://${{ secrets.PRODUCTION_HOST }}:8080/api/overview || exit 1
      
#       - name: Run smoke tests
#         run: |
#           echo "Running smoke tests..."
#           # Add your smoke test commands here