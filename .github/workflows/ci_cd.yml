# ============================================
# .github/workflows/microservices-ci-cd.yml
# Universal CI/CD Pipeline for Multi-Stack Microservices
# Supports: Python, Node.js, NestJS, PHP
# ============================================
name: Microservices CI/CD Pipeline
on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - 'services/**'
      - 'docker-compose.yml'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
      - develop
env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
jobs:
  # ==========================================
  # DETECT CHANGED SERVICES
  # ==========================================
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect.outputs.services }}
      matrix: ${{ steps.detect.outputs.matrix }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect changed services
        id: detect
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Detect which services changed
          SERVICES=()
          MATRIX_SERVICES='{"include":['
          
          for service_dir in services/*/; do
            service_name=$(basename "$service_dir")
            
            # Check if this service has changes
            if echo "$CHANGED_FILES" | grep -q "^services/$service_name/"; then
              echo "âœ… Detected changes in: $service_name"
              SERVICES+=("$service_name")
              
              # Detect service type
              if [ -f "$service_dir/requirements.txt" ]; then
                SERVICE_TYPE="python"
              elif [ -f "$service_dir/package.json" ]; then
                if grep -q "nestjs" "$service_dir/package.json"; then
                  SERVICE_TYPE="nestjs"
                else
                  SERVICE_TYPE="nodejs"
                fi
              elif [ -f "$service_dir/composer.json" ]; then
                SERVICE_TYPE="php"
              else
                SERVICE_TYPE="unknown"
              fi
              
              # Add to matrix
              MATRIX_SERVICES+="{\"name\":\"$service_name\",\"path\":\"$service_dir\",\"type\":\"$SERVICE_TYPE\"},"
            fi
          done
          
          # Remove trailing comma and close JSON
          MATRIX_SERVICES="${MATRIX_SERVICES%,}]}"
          
          # Output results
          echo "services=${SERVICES[@]}" >> $GITHUB_OUTPUT
          echo "matrix=$MATRIX_SERVICES" >> $GITHUB_OUTPUT
          
          echo "Services to test: ${SERVICES[@]}"
          echo "Matrix: $MATRIX_SERVICES"
  # ==========================================
  # TEST SERVICES (Multi-Stack)
  # ==========================================
  test:
    name: Test Services
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.services != ''
    
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: secret
          POSTGRES_DB: notifications
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U admin"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      rabbitmq:
        image: rabbitmq:3.12-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        ports:
          - 5672:5672
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ==========================================
      # PYTHON SERVICES
      # ==========================================
      - name: Set up Python
        if: matrix.type == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Cache Python dependencies
        if: matrix.type == 'python'
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles(format('{0}/requirements.txt', matrix.path)) }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        if: matrix.type == 'python'
        working-directory: ${{ matrix.path }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov flake8 black isort
      
      - name: Run Black (Python)
        if: matrix.type == 'python'
        working-directory: ${{ matrix.path }}
        run: black --check app/ || echo "âš ï¸ Black formatting issues found"
      
      - name: Run isort (Python)
        if: matrix.type == 'python'
        working-directory: ${{ matrix.path }}
        run: isort --check app/ || echo "âš ï¸ Import sorting issues found"
      
      - name: Run Flake8 (Python)
        if: matrix.type == 'python'
        working-directory: ${{ matrix.path }}
        run: flake8 app/ --max-line-length=100 --ignore=E501,W503,F401 || echo "âš ï¸ Flake8 issues found"
      
      - name: Run Python tests
        if: matrix.type == 'python'
        working-directory: ${{ matrix.path }}
        env:
          DATABASE_URL: postgresql://admin:secret@localhost:5432/notifications
          REDIS_HOST: localhost
          RABBITMQ_HOST: localhost
        run: |
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=term || echo "âš ï¸ Some tests failed"
      
      - name: Upload Python coverage
        if: matrix.type == 'python'
        uses: codecov/codecov-action@v3
        with:
          file: ${{ matrix.path }}/coverage.xml
          flags: ${{ matrix.name }}
          name: ${{ matrix.name }}-coverage
      
      # ==========================================
      # NODE.JS / NESTJS SERVICES
      # ==========================================
      - name: Set up Node.js
        if: matrix.type == 'nodejs' || matrix.type == 'nestjs'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Cache Node modules
        if: matrix.type == 'nodejs' || matrix.type == 'nestjs'
        uses: actions/cache@v3
        with:
          path: ${{ matrix.path }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles(format('{0}/package-lock.json', matrix.path)) }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Install Node dependencies
        if: matrix.type == 'nodejs' || matrix.type == 'nestjs'
        working-directory: ${{ matrix.path }}
        run: npm ci
      
      - name: Run ESLint (Node.js)
        if: matrix.type == 'nodejs' || matrix.type == 'nestjs'
        working-directory: ${{ matrix.path }}
        run: npm run lint || echo "âš ï¸ Linting issues found"
      
      - name: Run Prettier check (Node.js)
        if: matrix.type == 'nodejs' || matrix.type == 'nestjs'
        working-directory: ${{ matrix.path }}
        run: npm run format:check || echo "âš ï¸ Formatting issues found"
      
      - name: Build (Node.js/NestJS)
        if: matrix.type == 'nodejs' || matrix.type == 'nestjs'
        working-directory: ${{ matrix.path }}
        run: npm run build
      
      - name: Run Node.js tests
        if: matrix.type == 'nodejs' || matrix.type == 'nestjs'
        working-directory: ${{ matrix.path }}
        env:
          DATABASE_URL: postgresql://admin:secret@localhost:5432/notifications
          REDIS_HOST: localhost
          RABBITMQ_HOST: localhost
        run: npm test -- --coverage || echo "âš ï¸ Some tests failed"
      
      - name: Upload Node.js coverage
        if: matrix.type == 'nodejs' || matrix.type == 'nestjs'
        uses: codecov/codecov-action@v3
        with:
          file: ${{ matrix.path }}/coverage/lcov.info
          flags: ${{ matrix.name }}
          name: ${{ matrix.name }}-coverage
      
      # ==========================================
      # PHP SERVICES
      # ==========================================
      - name: Set up PHP
        if: matrix.type == 'php'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, pdo, pdo_pgsql, redis, amqp
          tools: composer, phpunit, phpstan, php-cs-fixer
      
      - name: Cache Composer dependencies
        if: matrix.type == 'php'
        uses: actions/cache@v3
        with:
          path: ${{ matrix.path }}/vendor
          key: ${{ runner.os }}-composer-${{ hashFiles(format('{0}/composer.lock', matrix.path)) }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install PHP dependencies
        if: matrix.type == 'php'
        working-directory: ${{ matrix.path }}
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
      
      - name: Run PHP-CS-Fixer
        if: matrix.type == 'php'
        working-directory: ${{ matrix.path }}
        run: ./vendor/bin/php-cs-fixer fix --dry-run --diff || echo "âš ï¸ Code style issues found"
      
      - name: Run PHPStan
        if: matrix.type == 'php'
        working-directory: ${{ matrix.path }}
        run: ./vendor/bin/phpstan analyse || echo "âš ï¸ Static analysis issues found"
      
      - name: Run PHP tests
        if: matrix.type == 'php'
        working-directory: ${{ matrix.path }}
        env:
          DATABASE_URL: postgresql://admin:secret@localhost:5432/notifications
          REDIS_HOST: localhost
          RABBITMQ_HOST: localhost
        run: ./vendor/bin/phpunit --coverage-clover=coverage.xml || echo "âš ï¸ Some tests failed"
      
      - name: Upload PHP coverage
        if: matrix.type == 'php'
        uses: codecov/codecov-action@v3
        with:
          file: ${{ matrix.path }}/coverage.xml
          flags: ${{ matrix.name }}
          name: ${{ matrix.name }}-coverage
  # ==========================================
  # BUILD AND PUSH DOCKER IMAGES
  # ==========================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    permissions:
      contents: read
      packages: write
    
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.name }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.path }}
          file: ${{ matrix.path }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.name }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.name }}:buildcache,mode=max
          build-args: |
            SERVICE_TYPE=${{ matrix.type }}
            BUILD_DATE=${{ steps.meta.outputs.labels['org.opencontainers.image.created'] }}
            VERSION=${{ steps.meta.outputs.version }}
  # ==========================================
  # INTEGRATION TESTS
  # ==========================================
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: secret
          POSTGRES_DB: notifications
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U admin"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      rabbitmq:
        image: rabbitmq:3.12-management-alpine
        ports:
          - 5672:5672
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Compose
        run: |
          docker-compose --version
      
      - name: Start all services
        run: |
          docker-compose up -d
          sleep 30
      
      - name: Check service health
        run: |
          docker-compose ps
          
          # Check API Gateway
          curl -f http://localhost:3000/api/v1/health || exit 1
          
          # Check other services if they expose health endpoints
          # curl -f http://localhost:8001/api/v1/health || echo "User service health check failed"
      
      - name: Run integration tests
        run: |
          # Add your integration test commands here
          echo "Running integration tests..."
          # pytest tests/integration/ -v
      
      - name: View logs on failure
        if: failure()
        run: |
          docker-compose logs
      
      - name: Cleanup
        if: always()
        run: |
          docker-compose down -v
  # ==========================================
  # DEPLOY TO PRODUCTION
  # ==========================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, integration-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            
            echo "ðŸ“¥ Pulling latest changes..."
            git pull origin main
            
            echo "ðŸ³ Pulling latest Docker images..."
            docker-compose pull
            
            echo "ðŸ”„ Restarting services with zero downtime..."
            docker-compose up -d --no-deps --remove-orphans
            
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "â³ Waiting for services to be healthy..."
            sleep 15
            
            echo "âœ… Deployment complete!"
            docker-compose ps
          EOF
      
      - name: Health check after deployment
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          # Wait for services to stabilize
          sleep 10
          
          # Check API Gateway health
          curl -f http://${{ env.SERVER_HOST }}:3000/api/v1/health || exit 1
          
          echo "âœ… All services are healthy!"
      
      - name: Deployment successful
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸ“¦ Repository: ${{ github.repository }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"
  # ==========================================
  # ROLLBACK (Manual Trigger)
  # ==========================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Rollback to previous version
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            
            echo "âª Rolling back to previous version..."
            git reset --hard HEAD^
            
            echo "ðŸ³ Rebuilding services..."
            docker-compose down
            docker-compose build
            docker-compose up -d
            
            echo "âœ… Rollback complete!"
          EOF